<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alert Suppression Inspector v6 (PDF Fix)</title>
    <link rel="icon" href="NyanCat.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- GLOBAL & SCREEN STYLES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0; padding: 0;
        }
        
        /* Dashboard Container */
        #dashboardContainer {
            display: block; /* Default visible */
        }

        h1 {
            background-color: #0515f0;
            color: #fff;
            padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
            margin: 0;
        }
        main {
            padding: 20px; margin: 20px auto;
            background-color: #fff;
            border-radius: 8px;
            width: 95%; max-width: 1400px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .editor-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .editor-box { flex: 1; }
        .editor { height: 200px; border: 1px solid #ccc; border-radius: 4px; }
        
        button {
            padding: 10px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-weight: bold; font-size: 14px;
        }
        .btn-primary { background: #2e06df; color: white; }
        .btn-primary:hover { background: #1c048a; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }

        /* Interactive Results */
        .result-card { border: 1px solid #ddd; margin-bottom: 8px; border-radius: 4px; background: #fff; }
        .result-header { padding: 10px; cursor: pointer; display: flex; justify-content: space-between; background: #f9f9f9; }
        .result-body { padding: 15px; display: none; border-top: 1px solid #eee; }
        .match-card { border-left: 5px solid green; }
        .mismatch-card { border-left: 5px solid #d00; }

        /* Comparison Styling (Screen) */
        .comp-row { display: flex; border: 1px solid #eee; margin-bottom: 5px; font-size: 13px; }
        .comp-label { width: 140px; background: #f0f0f0; padding: 5px; font-weight: bold; border-right: 1px solid #ddd; }
        .comp-val { flex: 1; padding: 5px; }
        .val-exp { background: #e6fffa; color: #006400; border-right: 1px solid #ddd; }
        .val-found { background: #fff0f0; color: #d00; }

        /* Loading Overlay */
        #loadingOverlay {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }

        /* --- PDF DOCUMENT STYLES (Hidden by default) --- */
        #pdfWrapper {
            display: none; /* Hidden until we want to print */
            background: #555;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }
        
        #pdfContainer {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm;
            box-sizing: border-box;
            font-family: 'Helvetica', 'Arial', sans-serif;
            font-size: 10pt;
            color: #000;
        }

        /* PDF Typography */
        .pdf-title { font-size: 20pt; font-weight: bold; color: #222; margin-bottom: 5px; border-bottom: 2px solid #0515f0; padding-bottom: 10px; }
        .pdf-meta { font-size: 9pt; color: #666; margin-bottom: 20px; }
        
        .pdf-section-title { 
            font-size: 12pt; font-weight: bold; 
            background: #eee; padding: 6px 10px; 
            margin-top: 20px; margin-bottom: 10px; 
            border-left: 5px solid #0515f0;
        }

        /* PDF Tables */
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 9pt; }
        .pdf-table td { border: 1px solid #ccc; padding: 6px; vertical-align: top; }
        .pdf-label { width: 25%; font-weight: bold; background: #f5f5f5; }

        /* PDF Cards */
        .pdf-card { 
            border: 1px solid #999; 
            margin-bottom: 12px; 
            page-break-inside: avoid; /* Important for PDF pagination */
            border-radius: 4px;
        }
        .pdf-card-header { padding: 6px 10px; font-weight: bold; font-size: 10pt; border-bottom: 1px solid #999; }
        .pdf-card-header.match { background: #d4edda; color: #155724; }
        .pdf-card-header.fail { background: #f8d7da; color: #721c24; }
        .pdf-card-body { padding: 8px 10px; }

        .pdf-comp-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 5px; }
        .pdf-comp-table th { text-align: left; background: #eee; padding: 4px; border: 1px solid #999; font-size: 8pt; }
        .pdf-comp-table td { padding: 4px; border: 1px solid #999; vertical-align: top; }
        .pdf-cell-fail { background: #fff5f5; color: #b00; font-weight: bold; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="font-size: 40px; margin-bottom: 15px;">‚öôÔ∏è</div>
    <div id="loadingText" style="font-size: 20px; font-weight: bold; color:#333;">Generating PDF Report...</div>
</div>

<div id="dashboardContainer">
    <h1>Alert Inspector <small style="font-size:14px; opacity:0.8; margin-left:10px;">v6 PDF Fix</small></h1>

    <main>
        <div class="editor-container">
            <div class="editor-box">
                <label><strong>1. Alert Data:</strong></label>
                <div id="alertEditor" class="editor"></div>
            </div>
            <div class="editor-box">
                <label><strong>2. Suppression Rules:</strong></label>
                <div id="ruleEditor" class="editor"></div>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <label><input type="checkbox" id="strictCaseCheck" checked> Strict Case Sensitivity</label>
                <button class="btn-primary" style="margin-left:15px;" onclick="startProcessing()">Validate Rules</button>
            </div>
            <button id="pdfBtn" class="btn-secondary" style="display:none;" onclick="downloadPDF()">üìÑ Download PDF Report</button>
        </div>
        
        <div id="screenResults" style="margin-top:20px;"></div>
    </main>
</div>

<div id="pdfWrapper" style="display:none;">
    <div id="pdfContainer">
        <div class="pdf-title">Suppression Analysis Report</div>
        <div class="pdf-meta" id="pdfDate"></div>

        <div class="pdf-section-title">1. Alert Context</div>
        <table class="pdf-table" id="pdfAlertTable">
            </table>

        <div class="pdf-section-title">2. Execution Summary</div>
        <table class="pdf-table">
            <tr>
                <td class="pdf-label">Total Rules Evaluated</td>
                <td id="pdfTotalRules">0</td>
                <td class="pdf-label">Overall Status</td>
                <td id="pdfStatus" style="font-weight:bold;">-</td>
            </tr>
        </table>

        <div class="pdf-section-title">3. Rule Details</div>
        <div id="pdfRulesList">
            </div>
    </div>
</div>

<script>
    // --- EDITOR SETUP ---
    const alertEditor = ace.edit("alertEditor");
    alertEditor.setTheme("ace/theme/monokai"); alertEditor.session.setMode("ace/mode/text");
    const ruleEditor = ace.edit("ruleEditor");
    ruleEditor.setTheme("ace/theme/monokai"); ruleEditor.session.setMode("ace/mode/json");

    // Field Name Mapping
    const fieldMap = {
        "ip": "IP Address", "os": "Operating System", "uid": "User ID", 
        "name": "Process Name", "path": "File Path", "sha1": "SHA1", 
        "sha256": "SHA256", "type": "Item Type", "hostname": "Hostname", 
        "commandLine": "Command Line", "parentProcessName": "Parent Process", 
        "signature.issuerName": "Signer", "targetGroupId": "Location ID",
        "organizationId": "Org ID", "avPositives": "AV Hits"
    };

    let globalAlertData = {};
    let globalResults = [];

    // --- MAIN PROCESSING ---
    function startProcessing() {
        document.getElementById('loadingText').innerText = "Analyzing Rules...";
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('screenResults').innerHTML = '';
        document.getElementById('pdfBtn').style.display = 'none';

        setTimeout(() => {
            try {
                executeAnalysis();
            } catch (e) {
                document.getElementById('screenResults').innerHTML = `<div style="color:red; padding:15px; border:1px solid red; border-radius:4px;">Error: ${e.message}</div>`;
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }, 100);
    }

    function executeAnalysis() {
        // 1. Get Data
        const alertText = alertEditor.getValue().trim();
        try { globalAlertData = JSON.parse(alertText); } 
        catch (e) { globalAlertData = parseKeyValue(alertText); }

        const ruleText = ruleEditor.getValue().trim();
        if(!ruleText) throw new Error("No rules provided.");
        
        let rawRules;
        try { rawRules = JSON.parse(ruleText); } catch(e) { throw new Error("Invalid Rule JSON"); }
        const rules = extractRules(rawRules);
        const strict = document.getElementById('strictCaseCheck').checked;

        // 2. Compare
        globalResults = rules.map(rule => ({
            meta: rule,
            result: compare(globalAlertData, rule, strict)
        }));
        
        // Sort matches first
        globalResults.sort((a,b) => (a.result.isMatch === b.result.isMatch) ? 0 : a.result.isMatch ? -1 : 1);

        // 3. Render Screen
        renderScreen();
        
        // 4. Pre-Render Hidden PDF DOM
        preparePDFDOM();
        
        document.getElementById('pdfBtn').style.display = 'block';
    }

    // --- SCREEN RENDERER ---
    function renderScreen() {
        const div = document.getElementById('screenResults');
        const matches = globalResults.filter(r => r.result.isMatch).length;
        
        div.innerHTML = `
            <div style="padding:15px; margin-bottom:20px; border-radius:5px; text-align:center; font-weight:bold; background:${matches > 0 ? '#d4edda' : '#f8d7da'}; color:${matches > 0 ? '#155724' : '#721c24'};">
                ${matches > 0 ? `‚úÖ SUPPRESSED: ${matches} matching rules found.` : `‚ùå TRIGGERED: No suppression rules matched.`}
            </div>
        `;

        globalResults.forEach(item => {
            const isMatch = item.result.isMatch;
            const card = document.createElement('div');
            card.className = `result-card ${isMatch ? 'match-card' : 'mismatch-card'}`;
            
            let html = `
                <div class="result-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='block'?'none':'block'">
                    <div>
                        <strong>${isMatch ? '‚úÖ' : '‚ùå'} ${escape(item.meta.name || 'Unnamed')}</strong> 
                        <span style="color:#888; font-size:12px;">(${item.meta.id})</span>
                    </div>
                    <div style="font-size:12px; color:#555;">‚ñº Details</div>
                </div>
                <div class="result-body">
            `;
            
            if(item.result.mismatches.length > 0) {
                html += `<div style="margin-bottom:5px; font-weight:bold; color:#d00;">Mismatches:</div>`;
                item.result.mismatches.forEach(m => {
                    html += `
                        <div class="comp-row">
                            <div class="comp-label">${fieldMap[m.field] || m.field}</div>
                            <div class="comp-val val-exp">Exp: ${escape(m.ruleVal)}</div>
                            <div class="comp-val val-found">Found: ${escape(m.alertVal)}</div>
                        </div>`;
                });
            }

            if(item.result.matches.length > 0) {
                html += `<div style="margin:10px 0 5px; font-weight:bold; color:green;">Matches:</div>`;
                html += item.result.matches.map(m => 
                    `<span style="background:#e6fffa; border:1px solid #c3e6cb; padding:2px 8px; border-radius:10px; font-size:12px; margin-right:5px; display:inline-block; margin-bottom:4px;">${fieldMap[m.field] || m.field}</span>`
                ).join('');
            }
            
            html += `</div>`;
            card.innerHTML = html;
            div.appendChild(card);
        });
    }

    // --- PDF DOM PREPARATION ---
    function preparePDFDOM() {
        document.getElementById('pdfDate').innerText = "Report Date: " + new Date().toLocaleString();

        // Fill Alert Table
        const table = document.getElementById('pdfAlertTable');
        table.innerHTML = '';
        const keyFields = ['hostname', 'ip', 'name', 'path', 'commandLine', 'parentProcessName', 'sha1'];
        keyFields.forEach(k => {
            const val = getVal(globalAlertData, k);
            if(val) table.innerHTML += `<tr><td class="pdf-label">${fieldMap[k] || k}</td><td>${escape(val)}</td></tr>`;
        });

        // Stats
        const matches = globalResults.filter(r => r.result.isMatch).length;
        document.getElementById('pdfTotalRules').innerText = globalResults.length;
        const statusElem = document.getElementById('pdfStatus');
        if(matches > 0) {
            statusElem.innerText = "SUPPRESSED (Matches Found)";
            statusElem.style.color = "green";
        } else {
            statusElem.innerText = "TRIGGERED (No Matches)";
            statusElem.style.color = "red";
        }

        // Fill Rules
        const list = document.getElementById('pdfRulesList');
        list.innerHTML = '';

        globalResults.forEach(item => {
            const isMatch = item.result.isMatch;
            const div = document.createElement('div');
            div.className = 'pdf-card';
            
            let headerClass = isMatch ? 'match' : 'fail';
            let icon = isMatch ? 'MATCH' : 'NO MATCH';
            
            let html = `
                <div class="pdf-card-header ${headerClass}">
                    [${icon}] ${escape(item.meta.name || 'Unnamed')} <span style="font-weight:normal; font-size:9pt;">(${item.meta.id})</span>
                </div>
                <div class="pdf-card-body">
            `;

            if (item.result.mismatches.length > 0) {
                html += `<div style="font-weight:bold; font-size:9pt; margin-bottom:4px; color:#d00;">Mismatched Conditions:</div>
                         <table class="pdf-comp-table">
                            <tr><th style="width:25%">Field</th><th style="width:35%">Expected</th><th style="width:40%">Found in Alert</th></tr>`;
                item.result.mismatches.forEach(m => {
                    html += `<tr>
                                <td>${fieldMap[m.field] || m.field}</td>
                                <td>${escape(m.ruleVal)}</td>
                                <td class="pdf-cell-fail">${escape(m.alertVal)}</td>
                             </tr>`;
                });
                html += `</table>`;
            }
            
            if (item.result.matches.length > 0) {
                html += `<div style="font-weight:bold; font-size:9pt; margin-top:8px; color:green;">Matched Conditions:</div>
                         <div style="font-size:8pt; margin-top:2px;">`;
                html += item.result.matches.map(m => `<span style="border:1px solid #ccc; padding:1px 4px; margin-right:4px; background:#f9f9f9; display:inline-block;">${fieldMap[m.field] || m.field}</span>`).join('');
                html += `</div>`;
            }

            html += `</div>`;
            div.innerHTML = html;
            list.appendChild(div);
        });
    }

    // --- PDF DOWNLOAD (VIEW SWAP FIX) ---
    function downloadPDF() {
        // 1. Show Loading
        document.getElementById('loadingText').innerText = "Generating PDF...";
        document.getElementById('loadingOverlay').style.display = 'flex';

        // 2. SWAP VIEWS: Hide Dashboard, Show PDF Wrapper
        const dashboard = document.getElementById('dashboardContainer');
        const pdfWrapper = document.getElementById('pdfWrapper');
        const pdfElement = document.getElementById('pdfContainer');

        dashboard.style.display = 'none';
        pdfWrapper.style.display = 'flex'; // Visible flex container

        const opt = {
            margin:       0,
            filename:     'Alert_Analysis_Report.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, scrollY: 0, windowWidth: 1200 }, // windowWidth helps ensure layout
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // 3. Generate
        html2pdf().set(opt).from(pdfElement).save().then(() => {
            // 4. Restore View
            pdfWrapper.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('loadingOverlay').style.display = 'none';
        }).catch(err => {
            alert("Error generating PDF: " + err);
            pdfWrapper.style.display = 'none';
            dashboard.style.display = 'block';
            document.getElementById('loadingOverlay').style.display = 'none';
        });
    }

    // --- LOGIC UTILS ---
    function extractRules(input) {
        if(Array.isArray(input)) return input;
        if(typeof input==='object' && input!==null) {
            if(Array.isArray(input.manifest)) return input.manifest;
            if(Array.isArray(input.rules)) return input.rules;
            if(input.metadata || input.id) return [input];
        }
        return [];
    }

    function compare(alertData, rule, strict) {
        let res = { matches:[], mismatches:[], isMatch: false, activeCount:0 };
        const meta = rule.metadata || {};
        
        for(let key in meta) {
            if(key === 'signature') continue;
            if(meta[key].active) {
                res.activeCount++;
                const aVal = getVal(alertData, key);
                const rVal = meta[key].value;
                if(check(aVal, rVal, meta[key].operator, meta[key].dataType, strict))
                    res.matches.push({field:key, ruleVal:rVal, alertVal:aVal});
                else res.mismatches.push({field:key, ruleVal:rVal, alertVal:aVal});
            }
        }
        if(meta.signature && meta.signature.issuerName && meta.signature.issuerName.active) {
            res.activeCount++;
            const aVal = getVal(alertData, 'signature.issuerName');
            const rVal = meta.signature.issuerName.value;
            if(check(aVal, rVal, '==', 'string', strict))
                res.matches.push({field:'signature.issuerName', ruleVal:rVal, alertVal:aVal});
            else res.mismatches.push({field:'signature.issuerName', ruleVal:rVal, alertVal:aVal});
        }
        res.isMatch = (res.activeCount > 0 && res.mismatches.length === 0);
        return res;
    }

    function check(aVal, rVal, op, type, strict) {
        if(aVal === undefined || aVal === null) return false;
        if(type === 'number') { return parseFloat(aVal) == parseFloat(rVal); }
        let a = String(aVal), r = String(rVal);
        if(!strict) { a=a.toLowerCase(); r=r.toLowerCase(); }
        if(r.includes('*')) {
            const rx = '^'+r.replace(/[.+^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*')+'$';
            return new RegExp(rx, strict?'':'i').test(a);
        }
        return op==='!=' ? a!==r : a===r;
    }

    function getVal(obj, path) { return path.split('.').reduce((o,i)=> (o?o[i]:undefined), obj); }
    function parseKeyValue(t) { let d={}; t.split('\n').forEach(l=>{ let p=l.split(':'); if(p.length>1) { let k=p.shift().trim(),v=p.join(':').trim(); if(k.includes('.')){let s=k.split('.');if(!d[s[0]])d[s[0]]={};d[s[0]][s[1]]=v}else d[k]=v; } }); return d; }
    function escape(s) { return s===undefined||s===null||s==='' ? '(empty)' : String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
