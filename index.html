<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alert Inspector v9 - Professional A4 Report</title>
    <link rel="icon" href="NyanCat.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* --- UI STYLES --- */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        #dashboard { max-width: 1300px; margin: 0 auto; padding: 20px; }
        header { background: #0515f0; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .editor-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .editor-wrap { flex: 1; background: white; padding: 15px; border-radius: 8px; }
        .editor { height: 250px; border: 1px solid #ccc; margin-top: 10px; }
        
        .action-bar { background: white; padding: 20px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        button { padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-run { background: #2e06df; color: white; }
        .btn-pdf { background: #28a745; color: white; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Results Screen */
        .res-card { background: white; border-radius: 8px; margin-top: 15px; border-left: 8px solid #ccc; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .res-header { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .res-content { padding: 20px; display: none; border-top: 1px solid #eee; background: #fafafa; }
        .is-match { border-left-color: #28a745; }
        .is-fail { border-left-color: #dc3545; }

        /* --- PDF PRINT TEMPLATE (Headless) --- */
        #pdf-render-zone {
            position: absolute; left: -10000px; top: 0;
            width: 210mm; /* Fixed A4 Width */
            background: white;
            padding: 0; margin: 0;
        }
        .pdf-page {
            width: 210mm;
            padding: 15mm 20mm; /* Standard Margins */
            box-sizing: border-box;
            font-family: "Helvetica", Arial, sans-serif;
            color: #333;
        }
        .pdf-header { border-bottom: 2pt solid #0515f0; padding-bottom: 10px; margin-bottom: 30px; }
        .pdf-section { margin-bottom: 25px; }
        .pdf-section-h { background: #f8f9fa; padding: 8px 12px; border-left: 4pt solid #0515f0; font-weight: bold; font-size: 13pt; margin-bottom: 10px; }
        
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; table-layout: fixed; }
        .pdf-table td { border: 1px solid #dee2e6; padding: 8px; font-size: 10pt; vertical-align: top; word-wrap: break-word; }
        .pdf-label { background: #f1f3f5; font-weight: bold; width: 35%; }

        .pdf-rule-item { border: 1px solid #ced4da; margin-bottom: 15px; border-radius: 4px; page-break-inside: avoid; }
        .pdf-rule-head { padding: 8px 12px; font-weight: bold; font-size: 11pt; border-bottom: 1px solid #ced4da; }
        .pdf-rule-head.match { background: #d4edda; color: #155724; }
        .pdf-rule-head.fail { background: #f8d7da; color: #721c24; }

        .comp-tbl { width: 100%; border-collapse: collapse; font-size: 9pt; }
        .comp-tbl th { background: #e9ecef; border: 1px solid #dee2e6; padding: 5px; text-align: left; }
        .comp-tbl td { border: 1px solid #dee2e6; padding: 5px; }
        .diff-val { color: #b02a37; font-weight: bold; background: #fff5f5; }

        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="overlay"><h2 id="loader-text">Processing Analysis...</h2></div>

<div id="dashboard">
    <header>
        <h1>Alert Suppression Inspector <small style="font-size: 12px; opacity: 0.7;">v9.0 Professional</small></h1>
    </header>

    <div class="editor-row">
        <div class="editor-wrap">
            <label><strong>1. Alert Evidence (JSON or Key:Value)</strong></label>
            <div id="alertEditor" class="editor"></div>
        </div>
        <div class="editor-wrap">
            <label><strong>2. Suppression Rules / Manifest</strong></label>
            <div id="ruleEditor" class="editor"></div>
        </div>
    </div>

    <div class="action-bar">
        <div>
            <label style="cursor: pointer;"><input type="checkbox" id="strictCase" checked> Strict Case Sensitivity</label>
            <button class="btn-run" style="margin-left: 20px;" onclick="runFullProcess()">Analyze & Validate</button>
        </div>
        <button id="pdfBtn" class="btn-pdf" style="display:none;" onclick="exportToA4PDF()">üìÑ Download A4 Report</button>
    </div>

    <div id="screenResults"></div>
</div>

<div id="pdf-render-zone">
    <div class="pdf-page">
        <div class="pdf-header">
            <h1 style="margin:0; color:#222;">Suppression Analysis Report</h1>
            <div id="pdf-timestamp" style="font-size:9pt; color:#666; margin-top:5px;"></div>
        </div>

        <div class="pdf-section">
            <div class="pdf-section-h">1. Alert Identification</div>
            <table class="pdf-table" id="pdf-alert-data"></table>
        </div>

        <div class="pdf-section">
            <div class="pdf-section-h">2. Executive Summary</div>
            <table class="pdf-table">
                <tr>
                    <td class="pdf-label">Determination</td>
                    <td id="pdf-summary-result" style="font-weight:bold; font-size:12pt;">-</td>
                </tr>
                <tr>
                    <td class="pdf-label">Rules Evaluated</td>
                    <td id="pdf-summary-count">0</td>
                </tr>
            </table>
        </div>

        <div class="pdf-section">
            <div class="pdf-section-h">3. Technical Findings</div>
            <div id="pdf-detailed-results"></div>
        </div>
    </div>
</div>

<script>
    // --- INITIALIZATION ---
    const alertEditor = ace.edit("alertEditor"); alertEditor.setTheme("ace/theme/chrome");
    const ruleEditor = ace.edit("ruleEditor"); ruleEditor.setTheme("ace/theme/monokai"); ruleEditor.session.setMode("ace/mode/json");

    const labels = {
        "hostname": "Host Name", "ip": "IP Address", "name": "Process Name", "path": "File Path",
        "commandLine": "Process Command Line", "sha1": "File SHA1", "sha256": "File SHA256",
        "parentProcessName": "Parent Process", "signature.issuerName": "Digital Signer"
    };

    let sessionData = { alert: {}, results: [] };

    // --- MAIN LOGIC ---
    function runFullProcess() {
        const alertRaw = alertEditor.getValue().trim();
        const ruleRaw = ruleEditor.getValue().trim();
        if(!alertRaw || !ruleRaw) return alert("Please provide both Alert Data and Rules.");

        try {
            // 1. Parse Alert
            try { sessionData.alert = JSON.parse(alertRaw); } 
            catch(e) { sessionData.alert = parseKV(alertRaw); }

            // 2. Parse Rules
            const parsedRules = JSON.parse(ruleRaw);
            const rulesArray = Array.isArray(parsedRules) ? parsedRules : (parsedRules.manifest || parsedRules.rules || [parsedRules]);

            // 3. Comparison
            const isStrict = document.getElementById('strictCase').checked;
            sessionData.results = rulesArray.map(r => validateRule(sessionData.alert, r, isStrict));
            
            // 4. Sort (Matches at top)
            sessionData.results.sort((a,b) => b.isMatch - a.isMatch);

            // 5. Update UI
            renderScreenResults();
            renderPDFZone();
            document.getElementById('pdfBtn').style.display = 'block';
        } catch(err) {
            alert("Analysis Error: " + err.message);
        }
    }

    function validateRule(alert, rule, strict) {
        let analysis = { meta: rule, matches: [], mismatches: [], isMatch: false, activeConditions: 0 };
        const meta = rule.metadata || {};

        // Iterate through all potential metadata fields
        for (let key in meta) {
            // Handle specific logic for 'signature' which is often nested
            if (key === 'signature' && meta.signature.issuerName) {
                processField(analysis, alert, 'signature.issuerName', meta.signature.issuerName, strict);
            } else if (meta[key] && meta[key].active) {
                processField(analysis, alert, key, meta[key], strict);
            }
        }

        analysis.isMatch = (analysis.activeConditions > 0 && analysis.mismatches.length === 0);
        return analysis;
    }

    function processField(res, alert, key, ruleObj, strict) {
        res.activeConditions++;
        const alertVal = getNestedValue(alert, key);
        const ruleVal = ruleObj.value;
        
        if (evaluate(alertVal, ruleVal, strict)) {
            res.matches.push({ field: key, ruleVal, alertVal });
        } else {
            res.mismatches.push({ field: key, ruleVal, alertVal });
        }
    }

    function evaluate(aVal, rVal, strict) {
        if (aVal === undefined || aVal === null) return false;
        let a = String(aVal), r = String(rVal);
        if (!strict) { a = a.toLowerCase(); r = r.toLowerCase(); }
        
        // Wildcard Support
        if (r.includes('*')) {
            const regex = new RegExp('^' + r.replace(/[.+^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*') + '$', strict ? '' : 'i');
            return regex.test(a);
        }
        return a === r;
    }

    // --- RENDERING ---
    function renderScreenResults() {
        const container = document.getElementById('screenResults');
        const matchCount = sessionData.results.filter(r => r.isMatch).length;
        
        container.innerHTML = `<div style="padding:15px; text-align:center; font-weight:bold; border-radius:8px; margin-bottom:20px; 
            background: ${matchCount > 0 ? '#d4edda; color:#155724' : '#f8d7da; color:#721c24'}">
            ${matchCount > 0 ? `PASS: Alert Suppressed by ${matchCount} rule(s).` : `FAIL: No matching suppression rules found.`}
        </div>`;

        sessionData.results.forEach((res, idx) => {
            const div = document.createElement('div');
            div.className = `res-card ${res.isMatch ? 'is-match' : 'is-fail'}`;
            div.innerHTML = `
                <div class="res-header" onclick="toggleDetails(${idx})">
                    <span>${res.isMatch ? '‚úÖ' : '‚ùå'} <strong>${res.meta.name || 'Unnamed Rule'}</strong> <small>(${res.meta.id || 'No ID'})</small></span>
                    <span>Details ‚ñº</span>
                </div>
                <div class="res-content" id="detail-${idx}">
                    ${res.mismatches.map(m => `<div style="color:#d00; margin-bottom:10px;"><strong>Mismatch [${labels[m.field]||m.field}]:</strong> Expected "${m.ruleVal}" but found "${m.alertVal}"</div>`).join('')}
                    ${res.matches.map(m => `<div style="color:green; font-size:0.9em;">‚úì Matched ${labels[m.field]||m.field}</div>`).join('')}
                </div>
            `;
            container.appendChild(div);
        });
    }

    function renderPDFZone() {
        document.getElementById('pdf-timestamp').innerText = "Technical Audit Performed: " + new Date().toLocaleString();
        
        // 1. Alert Data Table
        const tbl = document.getElementById('pdf-alert-data');
        tbl.innerHTML = '';
        ['hostname', 'ip', 'name', 'path', 'commandLine', 'signature.issuerName'].forEach(k => {
            const v = getNestedValue(sessionData.alert, k);
            if(v) tbl.innerHTML += `<tr><td class="pdf-label">${labels[k]||k}</td><td>${v}</td></tr>`;
        });

        // 2. Summary
        const matches = sessionData.results.filter(r => r.isMatch).length;
        const sumStat = document.getElementById('pdf-summary-result');
        sumStat.innerText = matches > 0 ? "SUPPRESSION CONFIRMED" : "ALERTE TRIGGERED (No Match)";
        sumStat.style.color = matches > 0 ? "#155724" : "#721c24";
        document.getElementById('pdf-summary-count').innerText = sessionData.results.length;

        // 3. Rule List
        const list = document.getElementById('pdf-detailed-results');
        list.innerHTML = '';
        sessionData.results.forEach(res => {
            const item = document.createElement('div');
            item.className = 'pdf-rule-item';
            item.innerHTML = `
                <div class="pdf-rule-head ${res.isMatch ? 'match' : 'fail'}">
                    Rule: ${res.meta.name} [${res.isMatch ? 'MATCHED' : 'NOT A MATCH'}]
                </div>
                <div style="padding:10px;">
                    ${res.mismatches.length > 0 ? `
                        <table class="comp-tbl">
                            <tr><th>Field</th><th>Required Value</th><th>Observed Value</th></tr>
                            ${res.mismatches.map(m => `<tr><td>${labels[m.field]||m.field}</td><td>${m.ruleVal}</td><td class="diff-val">${m.alertVal}</td></tr>`).join('')}
                        </table>
                    ` : `<p style="color:green; margin:0; font-size:10pt;">‚úî All ${res.activeConditions} active conditions were met.</p>`}
                </div>
            `;
            list.appendChild(item);
        });
    }

    function exportToA4PDF() {
        document.getElementById('loader-text').innerText = "Engaging PDF Engine...";
        document.getElementById('overlay').style.display = 'flex';

        const element = document.getElementById('pdf-render-zone');
        const opt = {
            margin: 0,
            filename: 'Suppression_Audit_Report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, windowWidth: 794 }, // 794px is the pixel width of A4 at 96 DPI
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            document.getElementById('overlay').style.display = 'none';
        });
    }

    // --- UTILITIES ---
    function toggleDetails(i) {
        const el = document.getElementById(`detail-${i}`);
        el.style.display = (el.style.display === 'block') ? 'none' : 'block';
    }

    function getNestedValue(obj, path) {
        return path.split('.').reduce((p, c) => p && p[c], obj);
    }

    function parseKV(text) {
        let obj = {};
        text.split('\n').forEach(line => {
            const parts = line.split(':');
            if (parts.length >= 2) {
                const key = parts[0].trim();
                const val = parts.slice(1).join(':').trim();
                if (key.includes('.')) {
                    const keys = key.split('.');
                    if (!obj[keys[0]]) obj[keys[0]] = {};
                    obj[keys[0]][keys[1]] = val;
                } else {
                    obj[key] = val;
                }
            }
        });
        return obj;
    }
</script>
</body>
</html>
